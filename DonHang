
package BookStore;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileWriter;
import java.io.IOException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Scanner;

public class DonHang {
    private ArrayList<CT_DonHang> dsDonHang = new ArrayList<>();

    public DonHang() {
    }

    public ArrayList<CT_DonHang> getDsDonHang() {
        return dsDonHang;
    }

    public void setDsDonHang(ArrayList<CT_DonHang> dsDonHang) {
        this.dsDonHang = dsDonHang;
    }

    public void timKiemDonHangTheoMaDon() {
    }
    
    public void timKiemDonHangTheoMaKhach() {
    }
    
    //phương thức cập nhật trạng thái đơn hàng
    //phương thức xem đơn hàng
    
    public void datHang() {
        for (CT_DonHang donhang : dsDonHang) {
            if (null!= donhang.getDsSach()) {
                donhang.setInfo();
                System.out.println("--BẠN CÓ XÁC NHẬN ĐẶT HÀNG?--");
                System.out.println("1. Đồng ý đặt hàng");
                System.out.println("2. Xem thêm sản phẩm");
                int chon = 0;
                do {
                    Scanner scan = new Scanner(System.in);
                    chon = Integer.parseInt(scan.nextLine());
                    switch (chon) {
                        case 1:
                            donhang.setTrangThai(1);
                            donhang.setMaDonHang(donhang.taoMaDH());
                            donhang.getDsSach();
                            donhang.setTongTien(donhang.tinhTongTien()); 
                            LocalDateTime myDateObj = LocalDateTime.now();   
                            DateTimeFormatter myFormatObj = DateTimeFormatter.ofPattern("dd/MM/yyyy");
                            donhang.setNgayDH(myDateObj.format(myFormatObj));
                            try (FileWriter fileWriter = new FileWriter("DonHang.txt", true)) {
                                    StringBuilder sb = new StringBuilder();
                                    sb.append(donhang.getKhachHang().getMaKH()).append("#");
                                    sb.append(donhang.getMaDonHang()).append("#");
                                    sb.append(donhang.getKhachHang().getEmail()).append("#");
                                    sb.append(donhang.chonDiaChi()).append("#");
                                    sb.append(donhang.getNgayDH()).append("#");
                                    for (int i = 0; i < donhang.getDsSach().size(); i++) {
                                        sb.append(donhang.getDsSach().get(i).getTenSach()).append(" x").append(donhang.getDsSach().get(i).getSoLuongMua()).append("; ");
                                    }
                                    sb.append("#");
                                    sb.append(donhang.tinhTongTien()).append("#");
                                    sb.append(donhang.getTrangThai()).append("#");
                                    sb.append(System.lineSeparator()); //Xuống dòng
                                    fileWriter.write(sb.toString()); //Ghi chuỗi thông tin vào file
                                    fileWriter.flush(); 
                                    System.out.println("ĐẶT HÀNG THÀNH CÔNG!");
                                    //phương thức cập nhật số lượng sách tồn kho
                            }
                                catch (IOException e) {
                                    System.out.println("\n ĐẶT HÀNG KHÔNG THÀNH CÔNG! \n");
                                    System.out.println("Có lỗi khi ghi vào file: " + e.getMessage());
                            }
                            break;
                        case 2:
                             //ve trang chu    
                    }
                    if (chon < 1 || chon > 2)
                            System.out.println("\n Vui lòng xác nhận đặt hàng! \n");
                } while (chon != 3);
            }
        }
    }
    
     public void docTuFile(String tenTapTin) {
        File file = new File(tenTapTin);
        try (Scanner scanner = new Scanner(file)) {
            while (scanner.hasNextLine()) {
                String line = scanner.nextLine();
                String[] parts = line.split("#");

                CT_DonHang donhang= new CT_DonHang();
                donhang.setMaDonHang(parts[0]);
                KhachHang khachHang = new KhachHang();
                donhang.setKhachHang(khachHang);
                khachHang.setMaKH(parts[1]);
                khachHang.setEmail(parts[2]);
                donhang.setDiaChi(parts[3]);
                donhang.setNgayDH(parts[4]);
                String sanpham = donhang.hienThiSanPham(parts[5]);
                String dulieu[] = sanpham.split(";");
                for (String dulieu1 : dulieu) {
                    String duLieuSanPham[] = dulieu1.split("x");
                    Sach sach = new Sach();
                    sach.setTenSach(duLieuSanPham[0]);
                    sach.setSoLuongMua(Integer.parseInt(duLieuSanPham[1]));
                    donhang.setDsSach(sach);
                }
                donhang.setTongTien(Double.parseDouble(parts[6]));
                donhang.setPtThanhToan(parts[7]);
                donhang.setTrangThai(Integer.parseInt(parts[8]));
                dsDonHang.add(donhang);
            }
        } catch (FileNotFoundException e) {
            System.out.println("Không tìm thấy file: " + e.getMessage());
        } catch (NumberFormatException e) {
            System.out.println("Lỗi khi phân tích số nguyên: " + e.getMessage());
        }
    }
    
    
//    public void ghiDsDonHangVaoFile() {
//        String fileName = "DonHang.txt";
//        File file = new File(fileName);
//        try (FileWriter fileWriter = new FileWriter(file, true)) {
//            for (CT_DonHang donhang : dsDonHang) {
//                if (donhang.getTrangThai() == 1) {
//                StringBuilder sb = new StringBuilder();
//                sb.append(donhang.getMaKhachHang()).append("#");
//                sb.append(donhang.getMaDonHang()).append("#");
//                sb.append(donhang.getEmail()).append("#");
//                sb.append(donhang.getDiaChi()).append("#");
//                if (donhang.getNgayDH()!= null) {
//                    sb.append(donhang.getNgayDH().getNgay()).append("#");
//                    sb.append(donhang.getNgayDH().getThang()).append("#");
//                    sb.append(donhang.getNgayDH().getNam()).append("#");
//                } else {
//                    sb.append("###");
//                }
//                sb.append(donhang.hienThiSanPham()).append("#");
//                sb.append(donhang.tinhTongTien()).append("#");
//                sb.append(donhang.getTrangThai()).append("#");
//                sb.append(System.lineSeparator()); //Xuống dòng
//                fileWriter.write(sb.toString()); //Ghi chuỗi thông tin vào file
//                fileWriter.flush(); 
//                }  
//            } 
//        }
//            catch (IOException e) {
//            System.err.println("Có lỗi khi ghi vào file: " + e.getMessage());
//        }
//    }
    
    
}
